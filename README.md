# CashCard

CashCard es una API RESTful desarrollada con Spring Boot para la gestión segura de tarjetas de efectivo virtuales. Permite a los usuarios autenticados crear, consultar, actualizar, listar y eliminar tarjetas de efectivo asociadas a su cuenta. El proyecto está diseñado para ser seguro, fácil de extender y sencillo de desplegar en entornos locales o de producción.

## Tabla de Contenidos
- [Características](#características)
- [Estructura del Proyecto](#estructura-del-proyecto)
- [Requisitos Previos](#requisitos-previos)
- [Instalación](#instalación)
- [Configuración](#configuración)
- [Uso](#uso)
- [Documentación de la API](#documentación-de-la-api)
- [Pruebas](#pruebas)
- [Despliegue](#despliegue)
- [Solución de Problemas](#solución-de-problemas)
- [Licencia](#licencia)

## Características
- API RESTful para CRUD de tarjetas de efectivo
- Seguridad basada en roles con Spring Security
- Autenticación HTTP Basic
- Persistencia con H2 (por defecto) y soporte para otras bases de datos
- Pruebas unitarias y de integración con JUnit y Spring Boot Test
- Ejemplo de serialización/deserialización JSON

## Estructura del Proyecto
```
├── src/
│   ├── main/
│   │   ├── java/mrearsbig/cashcard/
│   │   │   ├── CashCardApplication.java      # Punto de entrada principal
│   │   │   ├── CashCard.java                # Modelo de datos (entidad)
│   │   │   ├── CashCardController.java      # Controlador REST
│   │   │   ├── CashCardRepository.java      # Repositorio de datos
│   │   │   └── SecurityConfig.java          # Configuración de seguridad
│   │   └── resources/
│   │       ├── application.properties       # Configuración de la aplicación
│   │       └── schema.sql                   # Esquema de la base de datos
│   └── test/
│       ├── java/mrearsbig/cashcard/
│       │   ├── CashCardApplicationTests.java # Pruebas de integración
│       │   └── CashCardJsonTest.java         # Pruebas de serialización JSON
│       └── resources/
│           ├── data.sql                      # Datos de prueba
│           └── mrearsbig/cashcard/
│               ├── single.json
│               └── list.json
├── build.gradle                              # Configuración de Gradle
├── settings.gradle                           # Configuración de Gradle
```

## Requisitos Previos
- Java 21+
- Gradle 8+

## Instalación
1. Clona el repositorio:
   ```sh
   git clone https://github.com/mrearsbig/cashcard.git
   cd cashcard
   ```
2. Compila el proyecto y descarga las dependencias:
   ```sh
   ./gradlew build
   ```
3. (Opcional) Ejecuta los tests para verificar la instalación:
   ```sh
   ./gradlew test
   ```

## Configuración
La configuración principal se encuentra en `src/main/resources/application.properties`:
```properties
spring.application.name=CashCard
```

El esquema de la base de datos se define en `src/main/resources/schema.sql`:
```sql
CREATE TABLE cash_card (
    ID     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    AMOUNT NUMBER NOT NULL DEFAULT 0,
    OWNER  VARCHAR(256) NOT NULL
);
```

Para pruebas, los datos iniciales se cargan desde `src/test/resources/data.sql`.

## Uso
Para ejecutar la aplicación localmente:
```sh
./gradlew bootRun
```
La API estará disponible en `http://localhost:8080/cashcards`.

### Ejemplo de uso con curl
- Obtener una tarjeta:
  ```sh
  curl -u sarah1:abc123 http://localhost:8080/cashcards/99
  ```
- Crear una tarjeta:
  ```sh
  curl -u sarah1:abc123 -X POST -H "Content-Type: application/json" -d '{"amount": 50.0}' http://localhost:8080/cashcards
  ```

## Documentación de la API
### Endpoints principales
- `GET /cashcards/{id}`: Obtiene una tarjeta por ID (solo si es del usuario autenticado)
- `POST /cashcards`: Crea una nueva tarjeta para el usuario autenticado
- `GET /cashcards`: Lista todas las tarjetas del usuario autenticado (soporta paginación y ordenación)
- `PUT /cashcards/{id}`: Actualiza una tarjeta existente (solo si es del usuario autenticado)
- `DELETE /cashcards/{id}`: Elimina una tarjeta (solo si es del usuario autenticado)

#### Ejemplo de respuesta JSON
```json
{
  "id": 99,
  "amount": 123.45,
  "owner": "sarah1"
}
```

### Seguridad
- Autenticación HTTP Basic
- Solo los usuarios con el rol `CARD-OWNER` pueden acceder a los endpoints
- Usuarios de prueba definidos en `SecurityConfig.java` (por ejemplo: `sarah1/abc123`)

## Pruebas
Para ejecutar todas las pruebas:
```sh
./gradlew test
```
Las pruebas cubren:
- Integración de endpoints REST
- Serialización y deserialización JSON
- Seguridad y control de acceso

## Despliegue
La aplicación puede ejecutarse como un JAR autónomo:
```sh
./gradlew bootJar
java -jar build/libs/cashcard-0.0.1-SNAPSHOT.jar
```

## Solución de Problemas
- **Error 500**: Verifica que la entidad `CashCard` esté correctamente definida para Spring Data JDBC y que uses `org.springframework.data.annotation.Id`.
- **Problemas de autenticación**: Asegúrate de usar usuarios y contraseñas válidos definidos en la configuración de seguridad.
- **Base de datos**: Si usas otra base de datos, actualiza `application.properties` y el esquema SQL según corresponda.

## Licencia
Este proyecto está licenciado bajo la Licencia MIT. Consulta el archivo [LICENSE](LICENSE) para más detalles.
